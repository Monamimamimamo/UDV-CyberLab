version: '3.4'

services:
  identity:
    build:
      context: .
      dockerfile: Api/IdentityService/Api/Dockerfile
    ports:
      - "5215:5215"
    depends_on:
      db:
        condition: service_healthy
    environment:
      - ConnectionStrings__DefaultConnection=User ID=postgres;Password=123;Host=db;Port=5432;Database=identityNEOLab;Pooling=true;
      - ASPNETCORE_ENVIRONMENT=Development
      - SmtpSettings__Server=${SMTP_SERVER_VAR}
      - SmtpSettings__Port=${SMTP_PORT_VAR}
      - SmtpSettings__SenderName=${SMTP_SENDER_NAME_VAR}
      - SmtpSettings__SenderEmail=${SMTP_SENDER_EMAIL_VAR}
      - SmtpSettings__Username=${SMTP_USERNAME_VAR}
      - SmtpSettings__Password=${SMTP_PASSWORD_VAR}
      - ClientAppSettings__EmailConfirmationUrl=${CLIENT_EMAIL_CONFIRMATION_URL_VAR}
      - ClientAppSettings__PasswordResetUrl=${CLIENT_PASSWORD_RESET_URL_VAR}
    networks:
      - database
    restart: always

  tests:
    build:
      context: .
      dockerfile: Api/TestService/Api/Dockerfile
    ports:
      - "5068:5068"
    depends_on:
      tests-db:
        condition: service_healthy
    environment:
      - ConnectionStrings__DefaultConnection=User ID=postgres;Password=123;Host=tests-db;Port=5432;Database=testsNEOLab;Pooling=true;
      - ASPNETCORE_ENVIRONMENT=Development
      - YandexStorage__BucketName=${YANDEX_BUCKET_NAME}
      - YandexStorage__ServiceUrl=${YANDEX_SERVICE_URL}
      - YandexStorage__AccessKey=${YANDEX_ACCESS_KEY}
      - YandexStorage__SecretKey=${YANDEX_SECRET_KEY}
    networks:
      - database
    restart: always

  projects:
    build:
      context: .
      dockerfile: Api/ProjectService/Api/Dockerfile
    ports:
      - "5108:5108"
    depends_on:
      tests-db:
        condition: service_healthy
    environment:
      - ConnectionStrings__DefaultConnection=User ID=postgres;Password=123;Host=projects-db;Port=5432;Database=projectsNEOLab;Pooling=true;
      - ASPNETCORE_ENVIRONMENT=Development
      - YandexStorage__BucketName=${YANDEX_BUCKET_NAME}
      - YandexStorage__ServiceUrl=${YANDEX_SERVICE_URL}
      - YandexStorage__AccessKey=${YANDEX_ACCESS_KEY}
      - YandexStorage__SecretKey=${YANDEX_SECRET_KEY}
    networks:
      - database
    restart: always

  news:
    build:
      context: .
      dockerfile: Api/NewsService/NewsService/Dockerfile
    ports:
      - "5153:5153"
    depends_on:
      news-db:
        condition: service_healthy
    environment:
      - ConnectionStrings__DefaultConnection=User ID=postgres;Password=123;Host=news-db;Port=5432;Database=newsNEOLab;Pooling=true;
      - ASPNETCORE_ENVIRONMENT=Development
      - YandexStorage__BucketName=${YANDEX_BUCKET_NAME}
      - YandexStorage__ServiceUrl=${YANDEX_SERVICE_URL}
      - YandexStorage__AccessKey=${YANDEX_ACCESS_KEY}
      - YandexStorage__SecretKey=${YANDEX_SECRET_KEY}
    networks:
      - database
    restart: always

  learnmaterials:
    build:
      context: .
      dockerfile: Api/LearnMaterials/Api/Dockerfile
    ports:
      - "5158:5158"
    depends_on:
      learnmaterials-db:
        condition: service_healthy
    environment:
      - ConnectionStrings__DefaultConnection=User ID=postgres;Password=123;Host=learnmaterials-db;Port=5432;Database=learnmaterialsNEOLab;Pooling=true;
      - ASPNETCORE_ENVIRONMENT=Development
      - YandexStorage__BucketName=${YANDEX_BUCKET_NAME}
      - YandexStorage__ServiceUrl=${YANDEX_SERVICE_URL}
      - YandexStorage__AccessKey=${YANDEX_ACCESS_KEY}
      - YandexStorage__SecretKey=${YANDEX_SECRET_KEY}
    networks:
      - database
    restart: always

  db:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 123
      POSTGRES_DB: identityNEOLab
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    command: >
      postgres
      -c shared_preload_libraries=pg_stat_statements
    networks:
      - database
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  tests-db:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 123
      POSTGRES_DB: testsNEOLab
    volumes:
      - tests_postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    command: >
      postgres
      -c shared_preload_libraries=pg_stat_statements
    networks:
      - database
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  projects-db:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 123
      POSTGRES_DB: projectsNEOLab
    volumes:
      - projects_postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    command: >
      postgres
      -c shared_preload_libraries=pg_stat_statements
    networks:
      - database
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  news-db:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 123
      POSTGRES_DB: newsNEOLab
    volumes:
      - news_postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    command: >
      postgres
      -c shared_preload_libraries=pg_stat_statements
    networks:
      - database
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  learnmaterials-db:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 123
      POSTGRES_DB: learnmaterialsNEOLab
    volumes:
      - learnmaterials_postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    command: >
      postgres
      -c shared_preload_libraries=pg_stat_statements
    networks:
      - database
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    networks:
      - database
    depends_on:
      - db
      - tests-db

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    volumes:
      - grafana-storage:/var/lib/grafana
      - ./monitoring/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/datasources:/etc/grafana/provisioning/datasources
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    networks:
      - database
    depends_on:
      - prometheus



  postgres-exporter:
    image: prometheuscommunity/postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:123@db:5432/identityNEOLab?sslmode=disable"
    ports:
      - "9187:9187"
    networks:
      - database
    depends_on:
      - db

  tests-postgres-exporter:
    image: prometheuscommunity/postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:123@tests-db:5432/testsNEOLab?sslmode=disable"
    ports:
      - "9188:9187"
    networks:
      - database
    depends_on:
      - tests-db

volumes:
  postgres_data:
  tests_postgres_data:
  projects_postgres_data:
  news_postgres_data:
  learnmaterials_postgres_data:
  grafana-storage:

networks:
  database:
    driver: bridge